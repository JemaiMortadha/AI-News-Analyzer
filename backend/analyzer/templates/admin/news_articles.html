{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}
<style>
    .news-header {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .fetch-btn {
        background: #417690;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .fetch-btn:hover {
        background: #356578;
    }
</style>
{% endblock %}

{% block content %}
<h1>News Articles from MongoDB</h1>

<div class="news-header">
    <p><strong>Total Articles:</strong> {{ total_count }}</p>
    <form method="post" action="/admin/news-articles/fetch/" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="fetch-btn">üîÑ Fetch Latest News</button>
    </form>
</div>

<div class="module filtered" style="margin-bottom: 20px;">
    <form method="get" action="/admin/news-articles/" style="padding: 15px;">
        <h3>Filters</h3>
        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: end;">
            <div>
                <label for="search">Search:</label><br>
                <input type="text" name="search" id="search" value="{{ search_query }}"
                    placeholder="Title or description..." style="padding: 5px; width: 200px;">
            </div>

            <div>
                <label for="category">Category:</label><br>
                <select name="category" id="category" style="padding: 5px; width: 150px;">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>{{ cat|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="sentiment">Sentiment:</label><br>
                <select name="sentiment" id="sentiment" style="padding: 5px; width: 150px;">
                    <option value="">All Sentiments</option>
                    {% for sent in sentiments %}
                    <option value="{{ sent }}" {% if sent == selected_sentiment %}selected{% endif %}>{{ sent }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <button type="submit" class="button" style="padding: 6px 15px;">Apply Filters</button>
                <a href="/admin/news-articles/" class="button"
                    style="padding: 6px 15px; text-decoration: none;">Clear</a>
            </div>
        </div>
    </form>
</div>

<div class="module">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">
                <th style="padding: 10px; text-align: left; width: 40%;">Title</th>
                <th style="padding: 10px; text-align: left;">Source</th>
                <th style="padding: 10px; text-align: left;">Category</th>
                <th style="padding: 10px; text-align: left;">Sentiment</th>
                <th style="padding: 10px; text-align: left;">Published</th>
            </tr>
        </thead>
        <tbody>
            {% for article in articles %}
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;">
                    <a href="{{ article.url }}" target="_blank" style="color: #417690; text-decoration: none;">
                        {{ article.title|truncatechars:80 }}
                    </a>
                </td>
                <td style="padding: 10px;">{{ article.source }}</td>
                <td style="padding: 10px;">
                    <span style="background: #e3f2fd; padding: 3px 8px; border-radius: 3px; font-size: 12px;">
                        {{ article.category|title }}
                    </span>
                </td>
                <td style="padding: 10px;">
                    {% if article.sentiment|lower == "positive" %}
                    <span
                        style="background: #4caf50; color: white; padding: 3px 10px; border-radius: 3px; font-size: 12px;">{{
                        article.sentiment|title }}</span>
                    {% elif article.sentiment|lower == "negative" %}
                    <span
                        style="background: #f44336; color: white; padding: 3px 10px; border-radius: 3px; font-size: 12px;">{{
                        article.sentiment|title }}</span>
                    {% else %}
                    <span
                        style="background: #ff9800; color: white; padding: 3px 10px; border-radius: 3px; font-size: 12px;">{{
                        article.sentiment|title }}</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; font-size: 12px; color: #666;">
                    {{ article.published_at|date:"Y-m-d H:i" }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #999;">
                    No articles found. Try adjusting your filters or fetch news articles.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if total_pages > 1 %}
<div class="pagination" style="margin-top: 20px; text-align: center;">
    {% if has_previous %}
    <a href="?page={{ page|add:'-1' }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_sentiment %}&sentiment={{ selected_sentiment }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
        class="button">‚Üê Previous</a>
    {% endif %}

    <span style="margin: 0 15px;">Page {{ page }} of {{ total_pages }}</span>

    {% if has_next %}
    <a href="?page={{ page|add:'1' }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_sentiment %}&sentiment={{ selected_sentiment }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
        class="button">Next ‚Üí</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}